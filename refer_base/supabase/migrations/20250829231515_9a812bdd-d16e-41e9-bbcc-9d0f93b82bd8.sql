-- SubWatch Wise Íµ¨ÎèÖ Í¥ÄÎ¶¨ Ïï±ÏùÑ ÏúÑÌïú Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïä§ÌÇ§Îßà ÏÉùÏÑ±

-- 1. Íµ¨ÎèÖ Ïπ¥ÌÖåÍ≥†Î¶¨ ÌÖåÏù¥Î∏î
CREATE TABLE public.categories (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT NOT NULL UNIQUE,
  description TEXT,
  icon TEXT DEFAULT 'üì±',
  color TEXT DEFAULT '#3B82F6',
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);

-- 2. ÏÑúÎπÑÏä§ Ï†úÍ≥µÏóÖÏ≤¥ ÌÖåÏù¥Î∏î
CREATE TABLE public.merchants (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT NOT NULL,
  name_normalized TEXT NOT NULL,
  domain TEXT,
  logo_url TEXT,
  category_id UUID REFERENCES public.categories(id),
  cancel_url TEXT,
  support_url TEXT,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);

-- 3. Í∏∞Ï°¥ subscriptions ÌÖåÏù¥Î∏î ÏàòÏ†ï (merchant Ïó∞Îèô)
ALTER TABLE public.subscriptions 
ADD COLUMN IF NOT EXISTS merchant_id UUID REFERENCES public.merchants(id),
ADD COLUMN IF NOT EXISTS category_id UUID REFERENCES public.categories(id),
ADD COLUMN IF NOT EXISTS trial_end_date DATE,
ADD COLUMN IF NOT EXISTS last_charged_date DATE,
ADD COLUMN IF NOT EXISTS currency TEXT DEFAULT 'KRW',
ADD COLUMN IF NOT EXISTS tags TEXT[],
ADD COLUMN IF NOT EXISTS notes TEXT;

-- 4. ÏïåÎ¶º ÌÖåÏù¥Î∏î
CREATE TABLE public.alerts (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  subscription_id UUID REFERENCES public.subscriptions(id) ON DELETE CASCADE,
  type TEXT NOT NULL CHECK (type IN ('trial_expiry', 'price_increase', 'duplicate', 'unused', 'renewal_reminder')),
  title TEXT NOT NULL,
  message TEXT NOT NULL,
  action_url TEXT,
  priority TEXT DEFAULT 'medium' CHECK (priority IN ('low', 'medium', 'high', 'critical')),
  status TEXT DEFAULT 'unread' CHECK (status IN ('unread', 'read', 'dismissed', 'completed')),
  scheduled_for TIMESTAMP WITH TIME ZONE,
  sent_at TIMESTAMP WITH TIME ZONE,
  expires_at TIMESTAMP WITH TIME ZONE,
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);

-- 5. Ï†àÏïΩ Î™©Ìëú ÌÖåÏù¥Î∏î
CREATE TABLE public.saving_goals (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  title TEXT NOT NULL,
  description TEXT,
  target_amount INTEGER NOT NULL CHECK (target_amount > 0),
  current_amount INTEGER DEFAULT 0 CHECK (current_amount >= 0),
  target_date DATE,
  status TEXT DEFAULT 'active' CHECK (status IN ('active', 'completed', 'paused', 'cancelled')),
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);

-- 6. Ï†àÏïΩ Í∏∞Î°ù ÌÖåÏù¥Î∏î 
CREATE TABLE public.savings_records (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  subscription_id UUID REFERENCES public.subscriptions(id) ON DELETE CASCADE,
  goal_id UUID REFERENCES public.saving_goals(id) ON DELETE SET NULL,
  type TEXT NOT NULL CHECK (type IN ('cancel', 'downgrade', 'yearly_switch', 'coupon', 'negotiation', 'family_plan')),
  amount INTEGER NOT NULL CHECK (amount > 0),
  currency TEXT DEFAULT 'KRW',
  description TEXT NOT NULL,
  action_date DATE NOT NULL DEFAULT CURRENT_DATE,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);

-- 7. Îç∞Ïù¥ÌÑ∞ ÏóÖÎ°úÎìú Í∏∞Î°ù ÌÖåÏù¥Î∏î
CREATE TABLE public.ingest_uploads (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  filename TEXT NOT NULL,
  file_size INTEGER,
  mime_type TEXT,
  status TEXT DEFAULT 'processing' CHECK (status IN ('processing', 'completed', 'failed', 'cancelled')),
  total_rows INTEGER DEFAULT 0,
  processed_rows INTEGER DEFAULT 0,
  successful_rows INTEGER DEFAULT 0,
  failed_rows INTEGER DEFAULT 0,
  error_details JSONB DEFAULT '{}',
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);

-- 8. ÏÇ¨Ïö©Ïûê ÏÑ§Ï†ï ÌÖåÏù¥Î∏î
CREATE TABLE public.user_settings (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE UNIQUE,
  timezone TEXT DEFAULT 'Asia/Seoul',
  language TEXT DEFAULT 'ko',
  currency TEXT DEFAULT 'KRW',
  date_format TEXT DEFAULT 'YYYY-MM-DD',
  theme TEXT DEFAULT 'system' CHECK (theme IN ('light', 'dark', 'system')),
  notifications JSONB DEFAULT '{"email": true, "push": false, "trial_expiry": true, "price_increase": true}',
  privacy JSONB DEFAULT '{"profile_visibility": "private", "data_sharing": false}',
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);

-- RLS Ï†ïÏ±Ö ÏÑ§Ï†ï
ALTER TABLE public.categories ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.merchants ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.alerts ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.saving_goals ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.savings_records ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.ingest_uploads ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_settings ENABLE ROW LEVEL SECURITY;

-- Categories (Î™®Îì† ÏÇ¨Ïö©ÏûêÍ∞Ä Ï°∞Ìöå Í∞ÄÎä•)
CREATE POLICY "Anyone can view categories" ON public.categories FOR SELECT USING (true);

-- Merchants (Î™®Îì† ÏÇ¨Ïö©ÏûêÍ∞Ä Ï°∞Ìöå Í∞ÄÎä•)
CREATE POLICY "Anyone can view merchants" ON public.merchants FOR SELECT USING (true);

-- Alerts (ÏÇ¨Ïö©Ïûê Î≥∏Ïù∏Îßå Ï†ëÍ∑º)
CREATE POLICY "Users can view their own alerts" ON public.alerts 
  FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can create their own alerts" ON public.alerts 
  FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can update their own alerts" ON public.alerts 
  FOR UPDATE USING (auth.uid() = user_id);
CREATE POLICY "Users can delete their own alerts" ON public.alerts 
  FOR DELETE USING (auth.uid() = user_id);

-- Saving Goals (ÏÇ¨Ïö©Ïûê Î≥∏Ïù∏Îßå Ï†ëÍ∑º)
CREATE POLICY "Users can view their own saving goals" ON public.saving_goals 
  FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can create their own saving goals" ON public.saving_goals 
  FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can update their own saving goals" ON public.saving_goals 
  FOR UPDATE USING (auth.uid() = user_id);
CREATE POLICY "Users can delete their own saving goals" ON public.saving_goals 
  FOR DELETE USING (auth.uid() = user_id);

-- Savings Records (ÏÇ¨Ïö©Ïûê Î≥∏Ïù∏Îßå Ï†ëÍ∑º)
CREATE POLICY "Users can view their own savings records" ON public.savings_records 
  FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can create their own savings records" ON public.savings_records 
  FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can update their own savings records" ON public.savings_records 
  FOR UPDATE USING (auth.uid() = user_id);
CREATE POLICY "Users can delete their own savings records" ON public.savings_records 
  FOR DELETE USING (auth.uid() = user_id);

-- Ingest Uploads (ÏÇ¨Ïö©Ïûê Î≥∏Ïù∏Îßå Ï†ëÍ∑º)
CREATE POLICY "Users can view their own uploads" ON public.ingest_uploads 
  FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can create their own uploads" ON public.ingest_uploads 
  FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can update their own uploads" ON public.ingest_uploads 
  FOR UPDATE USING (auth.uid() = user_id);
CREATE POLICY "Users can delete their own uploads" ON public.ingest_uploads 
  FOR DELETE USING (auth.uid() = user_id);

-- User Settings (ÏÇ¨Ïö©Ïûê Î≥∏Ïù∏Îßå Ï†ëÍ∑º)
CREATE POLICY "Users can view their own settings" ON public.user_settings 
  FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can create their own settings" ON public.user_settings 
  FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can update their own settings" ON public.user_settings 
  FOR UPDATE USING (auth.uid() = user_id);

-- Ìä∏Î¶¨Í±∞ ÏÑ§Ï†ï (ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÍ∞Ñ ÏûêÎèô Í∞±Ïã†)
CREATE TRIGGER update_categories_updated_at
  BEFORE UPDATE ON public.categories
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

CREATE TRIGGER update_merchants_updated_at
  BEFORE UPDATE ON public.merchants
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

CREATE TRIGGER update_alerts_updated_at
  BEFORE UPDATE ON public.alerts
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

CREATE TRIGGER update_saving_goals_updated_at
  BEFORE UPDATE ON public.saving_goals
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

CREATE TRIGGER update_savings_records_updated_at
  BEFORE UPDATE ON public.savings_records
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

CREATE TRIGGER update_ingest_uploads_updated_at
  BEFORE UPDATE ON public.ingest_uploads
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

CREATE TRIGGER update_user_settings_updated_at
  BEFORE UPDATE ON public.user_settings
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

-- Ïù∏Îç±Ïä§ ÏÉùÏÑ± (ÏÑ±Îä• ÏµúÏ†ÅÌôî)
CREATE INDEX idx_subscriptions_user_id ON public.subscriptions(user_id);
CREATE INDEX idx_subscriptions_status ON public.subscriptions(status);
CREATE INDEX idx_subscriptions_next_billing ON public.subscriptions(next_billing);
CREATE INDEX idx_alerts_user_id ON public.alerts(user_id);
CREATE INDEX idx_alerts_status ON public.alerts(status);
CREATE INDEX idx_alerts_type ON public.alerts(type);
CREATE INDEX idx_savings_records_user_id ON public.savings_records(user_id);
CREATE INDEX idx_savings_records_type ON public.savings_records(type);
CREATE INDEX idx_saving_goals_user_id ON public.saving_goals(user_id);
CREATE INDEX idx_saving_goals_status ON public.saving_goals(status);

-- Í∏∞Î≥∏ Ïπ¥ÌÖåÍ≥†Î¶¨ Îç∞Ïù¥ÌÑ∞ ÏÇΩÏûÖ
INSERT INTO public.categories (name, description, icon, color) VALUES
('Ïä§Ìä∏Î¶¨Î∞ç', 'ÏòÅÏÉÅ Î∞è ÏùåÏïÖ Ïä§Ìä∏Î¶¨Î∞ç ÏÑúÎπÑÏä§', 'üé¨', '#EF4444'),
('ÏÜåÌîÑÌä∏Ïõ®Ïñ¥', 'ÏÉùÏÇ∞ÏÑ± Î∞è Í∞úÎ∞ú ÎèÑÍµ¨', 'üíª', '#3B82F6'),
('ÌîºÌä∏ÎãàÏä§', 'Ïö¥Îèô Î∞è Í±¥Í∞ï Í¥ÄÎ¶¨', 'üí™', '#10B981'),
('ÍµêÏú°', 'Ïò®ÎùºÏù∏ Í∞ïÏùò Î∞è ÌïôÏäµ', 'üìö', '#F59E0B'),
('Îâ¥Ïä§', 'Îâ¥Ïä§ Î∞è Îß§Í±∞ÏßÑ', 'üì∞', '#6B7280'),
('Í≤åÏûÑ', 'Í≤åÏûÑ Î∞è ÏóîÌÑ∞ÌÖåÏù∏Î®ºÌä∏', 'üéÆ', '#8B5CF6'),
('ÌÅ¥ÎùºÏö∞Îìú', 'ÌÅ¥ÎùºÏö∞Îìú Ïä§ÌÜ†Î¶¨ÏßÄ Î∞è Î∞±ÏóÖ', '‚òÅÔ∏è', '#06B6D4'),
('ÌÜµÏã†', 'Ïù∏ÌÑ∞ÎÑ∑ Î∞è Î™®Î∞îÏùº ÏöîÍ∏à', 'üì±', '#84CC16'),
('Í∏∞ÌÉÄ', 'Í∏∞ÌÉÄ Íµ¨ÎèÖ ÏÑúÎπÑÏä§', 'üì¶', '#64748B');

-- Ï£ºÏöî ÏÑúÎπÑÏä§ Ï†úÍ≥µÏóÖÏ≤¥ Îç∞Ïù¥ÌÑ∞ ÏÇΩÏûÖ
INSERT INTO public.merchants (name, name_normalized, domain, category_id) 
SELECT 
  'Netflix', 'netflix', 'netflix.com', c.id 
FROM public.categories c WHERE c.name = 'Ïä§Ìä∏Î¶¨Î∞ç'
UNION ALL
SELECT 
  'Spotify', 'spotify', 'spotify.com', c.id 
FROM public.categories c WHERE c.name = 'Ïä§Ìä∏Î¶¨Î∞ç'
UNION ALL
SELECT 
  'YouTube Premium', 'youtube_premium', 'youtube.com', c.id 
FROM public.categories c WHERE c.name = 'Ïä§Ìä∏Î¶¨Î∞ç'
UNION ALL  
SELECT 
  'Adobe Creative Cloud', 'adobe_cc', 'adobe.com', c.id 
FROM public.categories c WHERE c.name = 'ÏÜåÌîÑÌä∏Ïõ®Ïñ¥'
UNION ALL
SELECT 
  'Microsoft 365', 'microsoft_365', 'microsoft.com', c.id 
FROM public.categories c WHERE c.name = 'ÏÜåÌîÑÌä∏Ïõ®Ïñ¥';